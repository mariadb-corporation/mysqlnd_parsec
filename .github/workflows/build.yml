name: Windows Extension Build (php-windows-builder)

on:
  push:
    branches: [main, 1.0-georg]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-2022
    permissions:
      contents: read
    
    outputs:
      extension_version: ${{ steps.get_version.outputs.version }}

    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3', '8.4']
        arch: ['x64', 'x86']
        ts: ['ts', 'nts']

    steps:
      - name: Checkout Extension Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Extension Version
        id: get_version
        shell: pwsh
        run: |
          $version = Get-Content "php_mysqlnd_parsec.h" | Select-String '#define PHP_MARIADB_AUTH_PLUGIN_VERSION'
          $version = $version -split '"'
          "version=$($version[1])" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8 -Append

      - name: Build Extension (PHP ${{ matrix.php-version }} - ${{ matrix.ts }} - ${{ matrix.arch }})
        uses: php/php-windows-builder/extension@v1
        with:
          php-version: ${{ matrix.php-version }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}
          extension-url: https://github.com/9EOR9/mysqlnd_parsec
          args: --with-mysqlnd_parsec
          libs: "openssl-3, libsodium-1"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mysqlnd_parsec-${{ steps.get_version.outputs.version }}-${{ matrix.php-version }}-${{ matrix.ts }}-${{ matrix.arch }}
          path: build/**/php_mysqlnd_parsec.dll
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'release' }}
    permissions:
      contents: write

    steps:
      - name: Download all built artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: mysqlnd_parsec-*
          path: artifacts

      - name: Consolidate and Package DLLs
        shell: bash
        run: |
          mkdir release_assets

          # Use the release tag as the version identifier
          TAG="${{ github.event.release.tag_name }}"

          for artifact_dir in artifacts/*; do
            MATRIX_INFO=$(basename "$artifact_dir" | sed 's/^mysqlnd_parsec-//')
            PHP_VER=$(echo "$MATRIX_INFO" | cut -d- -f2)
            TS=$(echo "$MATRIX_INFO" | cut -d- -f3)
            ARCH=$(echo "$MATRIX_INFO" | cut -d- -f4)

            # Determine compiler version based on PHP version
            if [[ "$PHP_VER" == 8.[0-3]* ]]; then
              COMPILER="vs16"
            else
              COMPILER="vs17"
            fi

            # Normalize architecture name
            case "$ARCH" in
              x64|x86_64|AMD64) ARCH_NORM="x86_64" ;;
              arm64|aarch64) ARCH_NORM="arm64" ;;
              *) ARCH_NORM="x86" ;;
            esac

            DLL_FILE=$(find "$artifact_dir" -name "*.dll" | head -n 1)
            if [ -z "$DLL_FILE" ]; then
              echo "Warning: No DLL found in $artifact_dir. Skipping."
              continue
            fi

            # PIE-compliant filenames
            ZIP_NAME="php_mysqlnd_parsec-${TAG}-${PHP_VER}-${TS}-${COMPILER}-${ARCH_NORM}.zip"
            DLL_BASENAME="php_mysqlnd_parsec-${TAG}-${PHP_VER}-${TS}-${COMPILER}-${ARCH_NORM}.dll"

            echo "Packaging $DLL_FILE â†’ $ZIP_NAME"
            cp "$DLL_FILE" "./$DLL_BASENAME"
            zip -q "release_assets/$ZIP_NAME" "$DLL_BASENAME"
            rm "$DLL_BASENAME"
          done

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release_assets/*
          tag_name: ${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true


